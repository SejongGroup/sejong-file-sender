<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cbiz">
	
	<select id="getCallingNum" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO" resultType="String">
		SELECT DISTINCT 
			CALLING_NUM
		FROM 
			${cdrNumber}
		WHERE CSTIME = #{cstime}
			AND CETIME = #{cetime}
			AND ACCESS_NUM = #{vnsNumber}
	</select>
	
	<select id="selectCbizCheat" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO" resultType="Integer">
		SELECT Count(*)
		FROM 
			TB_VNS_CHEAT_NUMBER
		WHERE CALLING_NUMBER = #{searchNum}
	</select>
	
	<select id="selectCallingFlag" parameterType="hashmap" resultType="String">
		SELECT FLAG FROM (
			SELECT * FROM TB_VNS_CHEAT_TEMP
			WHERE CALLING_HASH = #{callingHash}
			ORDER BY SEQ DESC
		)
		WHERE ROWNUM=1
	</select>
	
	<select id="selectNextSequence" parameterType="string" resultType="long">
		SELECT
			${value}
		FROM 
			dual
	</select>
	
	<insert id="insertCheatNumTemp" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO">
		INSERT INTO 
			TB_VNS_CHEAT_TEMP (SEQ, VNS_NUMBER, CALLING_HASH, CSTIME, CETIME, CALL_ID, LVL, FLAG)
		values (#{seq}, #{vnsNumber}, #{callingHash}, #{cstime}, #{cetime}, #{callId}, #{level}, #{flag})
	</insert>
	
	<insert id="insertCheatNumMain" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO">
		INSERT INTO 
			TB_VNS_CHEAT_NUMBER (CALLING_NUMBER, MENT_TYPE, MOD_ID, CALLING_HASH)
		values (#{callingNum}, #{level}, 'system', #{callingHash})
	</insert>
	
	<update id="updateCheatNumTemp" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO">
		UPDATE TB_VNS_CHEAT_TEMP
		SET FLAG=#{setFlag}
		WHERE SEQ=#{seq} AND CSTIME=#{cstime} AND CETIME=#{cetime} AND VNS_NUMBER=#{vnsNumber} AND FLAG=#{flag}
	</update>
	
	<update id="updateCheatNumMain" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO">
		UPDATE TB_VNS_CHEAT_NUMBER
		SET MENT_TYPE=#{level}
		WHERE CALLING_NUMBER=#{callingNum} AND CALLING_HASH=#{callingHash}
	</update>
	
	<select id="sequenceNumber" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO" resultType="String">
		SELECT SEQ
		FROM 
			TB_VNS_CHEAT_TEMP
		WHERE CSTIME = #{cstime}
			AND CETIME = #{cetime}
			AND VNS_NUMBER = #{vnsNumber}
			AND CALLING_HASH = #{callingHash}
			AND FLAG = 'R'
	</select>
	
	<delete id="deleteCheatNumMain" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO">
		DELETE
		FROM TB_VNS_CHEAT_NUMBER
		WHERE CALLING_HASH=#{callingHash}
	</delete>
	
	<select id="insertOrupdate" parameterType="com.sejong.cdbiz.cbiz.vo.CheatMentVO" resultType="Integer">
		SELECT Count(*)
		FROM 
			TB_VNS_CHEAT_NUMBER
		WHERE CALLING_NUMBER = #{callingNum}
			AND CALLING_HASH = #{callingHash}
	</select>
</mapper>